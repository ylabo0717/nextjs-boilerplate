# PRレビューチェックリスト

このチェックリストは **PR作成者** と **レビュアー** 両方が使用します。
該当しない項目は ~~N/A~~ として進めてください。

---

## 🚨 必須チェック（ブロッカー）

これらの項目に問題がある場合、マージを **ブロック** してください。

### セキュリティ

- [ ] **機密情報の流出防止**: APIキー、パスワード、シークレットがクライアントコードに含まれていない
- [ ] **シークレットスキャン通過**: gitleaksまたは同等ツールでシークレット検出されない
- [ ] **ハードコード禁止**: パスワード、API Key等が直接コードに埋め込まれていない（環境変数経由のみ）
- [ ] **認証・認可**: サーバー側で最終的な権限チェックを実施している（クライアント側チェックはUX補助のみ）
- [ ] **入力値検証**: API、フォーム、環境変数の外部入力にZodやschema検証を実装
- [ ] **XSS対策**: ユーザー入力を適切にサニタイズ・エスケープしている
- [ ] **機密ログ防止**: パスワード、トークンなどをconsole.logやログ出力に含めていない

### 型安全性

- [ ] **any禁止**: `any`型を使用していない（やむを得ない場合はコメントで理由説明必須）
- [ ] **unknown活用**: 外部データは`unknown`で受け取り、型ガードやZodで検証している
- [ ] **型の一貫性**: 公開APIの戻り値型が安定している（破壊的変更時はCHANGELOG記載）

### CI/品質ゲート

- [ ] **Lint成功**: `pnpm lint`がエラーなしで完了
- [ ] **型チェック成功**: `pnpm typecheck`がエラーなしで完了
- [ ] **テスト成功**: `pnpm test`が全て成功
- [ ] **ビルド成功**: `pnpm build`が成功

---

## ⚠️ 重要チェック（修正強く推奨）

### アーキテクチャ・設計

- [ ] **純粋関数優先**: ビジネスロジックが純粋関数として実装されている
- [ ] **副作用の分離**: I/O、時刻取得、乱数生成が境界層（API route、useEffect等）に集中
- [ ] **IIFE/クロージャー回避**: IIFE（即座実行関数式）を避けて純粋関数を使用している
- [ ] **SSOT原則**: 重複する定数・設定値が`src/constants/`から参照されている
- [ ] **クラス使用理由**: クラスを使用する場合、以下の理由がコメントで説明されている
  - 状態管理・リソース管理・ライフサイクル管理が必要
  - 外部システム（DB、API、ファイル）との接続管理
  - インターフェース実装や環境固有の制約

### Next.js 15 + React 19 ベストプラクティス

- [ ] **Server/Client分離**: 不要なClient Component化を避けている（`'use client'`の必要性を確認）
- [ ] **データ取得最適化**: サーバー側でのデータ取得を優先している
- [ ] **非同期params対応**: `params`と`searchParams`を`await`で取得している（Next.js 15）
- [ ] **Server Actions**: Server Actions使用時に適切なエラーハンドリングを実装
- [ ] **新フック活用**: `useActionState`等のReact 19新機能を適切に使用

### パフォーマンス

- [ ] **バンドル影響**: 新規依存関係がバンドルサイズに与える影響を確認済み
- [ ] **動的インポート**: 大型ライブラリに動的インポート (`import()`) を検討済み
- [ ] **再レンダー最適化**: 不要な再レンダーを防ぐため、依存配列やprops設計を最適化
- [ ] **画像最適化**: Next.js Imageコンポーネント、WebP/AVIF形式を適切に使用
- [ ] **Core Web Vitals**: パフォーマンス指標への影響を考慮済み

---

## 💡 改善チェック（推奨）

### コード品質

- [ ] **複雑度**: 関数の複雑度が適切（1関数10行以下、ネスト3層以下推奨）
- [ ] **魔法数字排除**: 数値リテラルが定数として抽出されている（テスト定数含む）
- [ ] **デッドコード**: 使用されていないコード、import、変数を削除済み
- [ ] **命名**: 変数・関数名が意図を明確に表現している
- [ ] **構造化ログ**: ログ出力に統合ロガーを使用し、適切なログレベルとコンテキストを設定
- [ ] **GDPR準拠**: 個人情報（IP、メールアドレス等）をログ出力時に適切にハッシュ化・マスク化

### アクセシビリティ

- [ ] **セマンティック**: 適切なHTML要素（button、a、form等）を使用
- [ ] **ラベル**: フォーム要素に適切なlabel、aria-labelを設定
- [ ] **キーボード操作**: Tab、Enter、Escapeキーで操作可能
- [ ] **コントラスト**: 色のコントラスト比がWCAG 2.1基準を満たす

### テスト

- [ ] **テスト更新**: 変更ロジックに対応するテスト（Unit/Integration/E2E）を更新
- [ ] **エラーケーステスト**: エラーパス、境界値のテストケースを含む
- [ ] **モック最小化**: 過度なモックを避け、実際の振る舞いをテスト

### エラーハンドリング・UX

- [ ] **Error Boundary**: 適切な位置にError Boundaryを配置
- [ ] **ユーザーフレンドリーエラー**: 技術的でないエラーメッセージを表示
- [ ] **ローディング状態**: 非同期処理中のローディング・ペンディング状態を表示
- [ ] **フォールバック**: ネットワークエラー等の際のフォールバックUIを提供

---

## 📝 ドキュメント・保守性

- [ ] **TSDoc**: 新しい公開関数・定数にTSDocコメントを追加
- [ ] **READMEの整合性**: 既存ドキュメントとの矛盾がない
- [ ] **TODOコメント**: TODO、FIXMEコメントに期限・担当者を記載
- [ ] **変更理由**: 大きな設計変更に背景・理由をコメント記載

---

## 📋 PRテンプレート

PR説明文に以下をコピーして使用してください：

```markdown
## 変更概要

<!-- 何を変更したかを簡潔に説明 -->

## 動作確認

<!-- テスト方法やスクリーンショット -->

## チェックリスト

### 🚨 必須（ブロッカー）

- [ ] セキュリティ: 機密情報流出なし、入力値検証実装
- [ ] 型安全性: any不使用、unknown+型ガード活用
- [ ] CI: Lint/Type/Test/Build 全て成功

### ⚠️ 重要（修正推奨）

- [ ] アーキテクチャ: 純粋関数優先、SSOT原則遵守
- [ ] Next.js & React: Server/Client適切分離、新機能適切使用
- [ ] パフォーマンス: バンドル影響確認、最適化実装

### 💡 改善（推奨）

- [ ] コード品質: 複雑度適切、魔法数字なし
- [ ] アクセシビリティ: セマンティック、キーボード対応
- [ ] テスト: 変更に対応するテスト更新
- [ ] エラーハンドリング: 適切なエラー処理とUX

### 📝 ドキュメント

- [ ] TSDoc: 新規公開API用ドキュメント追加
- [ ] 変更理由: 設計変更の背景説明
```

## 関連事項

<!-- 関連するIssue、PR、ドキュメントへのリンク -->

---

## 🔍 レビュアー向けガイド

### 優先して確認すべき順序

1. **🚨 必須チェック** → 問題があればマージブロック
2. **⚠️ 重要チェック** → 修正を強く推奨、説明を求める
3. **💡 改善チェック** → 提案レベル、将来の改善として記録

### レビューコメントの書き方

- **ブロッカー**: `[BLOCKER] セキュリティ: APIキーがクライアントコードに含まれています`
- **重要**: `[IMPORTANT] パフォーマンス: この依存関係はバンドルサイズに大きな影響があります`
- **提案**: `[SUGGESTION] 複雑度: この関数を分割すると可読性が向上しそうです`

---

---

## 🎯 外部レビュー観点（定期的セキュリティチェック）

### セキュリティ強化チェック

- [ ] **環境変数化**: 本番設定でハードコードされた認証情報がない
- [ ] **シークレットスキャン設定**: `config/security/.gitleaks.toml`が適切に設定され、偽陽性を最小化
- [ ] **アクセス制御**: 管理画面、監視ツールのデフォルト認証情報が変更済み
- [ ] **ログ機密性**: 構造化ログでPII（個人識別情報）が適切にマスク化

### アーキテクチャ健全性チェック

- [ ] **関数パラダイム**: IIFE、複雑なクロージャーを純粋関数にリファクタリング
- [ ] **状態管理の妥当性**: クラス使用が必要な理由を適切にドキュメント化
- [ ] **テストカバレッジ**: エラーパス、Edge cases の網羅性確認
- [ ] **言語一貫性**: チーム合意に基づく言語使用（日英混在の最小化）

**📅 推奨頻度**: 四半期ごと、または大きな機能追加後

---

**関連ガイドライン:**

- [概要](./coding-guidelines-overview.md) - 基本方針とSSOT原則
- [TypeScript](./typescript-guidelines.md) - 型安全性ガイドライン
- [Next.js パターン](./nextjs-patterns.md) - Server/Client Components
- [セキュリティ](./security-guidelines.md) - セキュアな実装
- [ドキュメント](./documentation-guidelines.md) - TSDoc標準
