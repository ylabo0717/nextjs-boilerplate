name: Dependency Update Check

on:
  schedule:
    # Run every Monday at 1:00 AM UTC
    - cron: '0 1 * * 1'
  workflow_dispatch:
    inputs:
      update-type:
        description: 'Type of update to perform'
        required: true
        default: 'patch'
        type: choice
        options:
          - patch
          - minor
          - major
          - latest

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  check-updates:
    name: Check for Updates
    runs-on: ubuntu-latest
    outputs:
      has-updates: ${{ steps.check.outputs.has-updates }}
      update-summary: ${{ steps.check.outputs.summary }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9
          run_install: false

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Check for outdated packages
        id: check
        run: |
          # Check for outdated packages
          echo "üì¶ Checking for outdated packages..."

          # Get outdated packages in JSON format
          pnpm outdated --format json > outdated.json || true

          # Parse and display outdated packages
          if [ -s outdated.json ] && [ "$(cat outdated.json)" != "{}" ]; then
            echo "has-updates=true" >> $GITHUB_OUTPUT
            
            # Create summary
            SUMMARY=$(printf "## üì¶ Outdated Dependencies Found\n\n")
            SUMMARY=$(printf "%s| Package | Current | Wanted | Latest | Type |\n" "$SUMMARY")
            SUMMARY=$(printf "%s|---------|---------|--------|--------|------|\n" "$SUMMARY")
            
            # Parse JSON and create table (using jq if available, otherwise use node)
            node -e "
              const outdated = require('./outdated.json');
              Object.entries(outdated).forEach(([name, info]) => {
                const type = info.dependencyType || 'dependencies';
                console.log(\`| \${name} | \${info.current} | \${info.wanted} | \${info.latest} | \${type} |\`);
              });
            " >> summary.md
            
            if [ -s summary.md ]; then
              SUMMARY=$(printf "%s%s" "$SUMMARY" "$(cat summary.md)")
            fi
            
            echo "summary<<EOF" >> $GITHUB_OUTPUT
            echo "$SUMMARY" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
            
            # Display in logs
            echo "$SUMMARY"
          else
            echo "has-updates=false" >> $GITHUB_OUTPUT
            echo "‚úÖ All dependencies are up to date!"
          fi

      - name: Upload outdated report
        if: steps.check.outputs.has-updates == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: outdated-dependencies
          path: outdated.json
          retention-days: 7

  update-dependencies:
    name: Update Dependencies
    runs-on: ubuntu-latest
    needs: check-updates
    if: needs.check-updates.outputs.has-updates == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9
          run_install: false

      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Update dependencies
        id: update
        run: |
          UPDATE_TYPE="${{ github.event.inputs.update-type || 'patch' }}"
          echo "üîÑ Performing $UPDATE_TYPE updates..."

          # Store initial lock file
          cp pnpm-lock.yaml pnpm-lock.yaml.bak

          case "$UPDATE_TYPE" in
            patch)
              # Update patch versions only
              pnpm update --recursive --prod
              pnpm update --recursive --dev
              ;;
            minor)
              # Update minor versions
              pnpm update --recursive --prod --latest
              pnpm update --recursive --dev --latest
              ;;
            major)
              # Update major versions (interactive mode not available in CI)
              echo "‚ö†Ô∏è Major updates require manual intervention"
              # For major updates, we'll create a list instead
              pnpm outdated > major-updates.txt || true
              ;;
            latest)
              # Update to latest versions
              pnpm update --recursive --latest
              ;;
          esac

          # Check if lock file changed
          if ! diff -q pnpm-lock.yaml pnpm-lock.yaml.bak > /dev/null 2>&1; then
            echo "updates-made=true" >> $GITHUB_OUTPUT
            
            # Generate changelog
            echo "## üìù Update Summary" > update-summary.md
            echo "" >> update-summary.md
            echo "Update type: **$UPDATE_TYPE**" >> update-summary.md
            echo "" >> update-summary.md
            
            # List updated packages (simplified)
            echo "### Updated Packages:" >> update-summary.md
            pnpm list --depth=0 >> update-summary.md
          else
            echo "updates-made=false" >> $GITHUB_OUTPUT
            echo "No updates were necessary"
          fi

      - name: Run tests
        id: tests
        if: steps.update.outputs.updates-made == 'true'
        run: |
          echo "üß™ Running tests after updates..."

          # Initialize test results
          TEST_RESULTS=""
          ALL_PASSED=true

          # Run linting
          if pnpm lint; then
            TEST_RESULTS=$(printf "%s‚úÖ Lint check passed\n" "$TEST_RESULTS")
          else
            TEST_RESULTS=$(printf "%s‚ùå Lint check failed\n" "$TEST_RESULTS")
            ALL_PASSED=false
          fi

          # Run type checking
          if pnpm typecheck; then
            TEST_RESULTS=$(printf "%s‚úÖ Type check passed\n" "$TEST_RESULTS")
          else
            TEST_RESULTS=$(printf "%s‚ùå Type check failed\n" "$TEST_RESULTS")
            ALL_PASSED=false
          fi

          # Run tests if they exist
          if [ -f "vitest.config.ts" ]; then
            if pnpm test:unit; then
              TEST_RESULTS=$(printf "%s‚úÖ Unit tests passed\n" "$TEST_RESULTS")
            else
              TEST_RESULTS=$(printf "%s‚ùå Unit tests failed\n" "$TEST_RESULTS")
              ALL_PASSED=false
            fi
          else
            TEST_RESULTS=$(printf "%s‚è≠Ô∏è Unit tests skipped (no test config found)\n" "$TEST_RESULTS")
          fi

          # Run build
          if pnpm build; then
            TEST_RESULTS=$(printf "%s‚úÖ Build succeeded\n" "$TEST_RESULTS")
          else
            TEST_RESULTS=$(printf "%s‚ùå Build failed\n" "$TEST_RESULTS")
            ALL_PASSED=false
          fi

          # Save results for PR body
          echo "test-results<<EOF" >> $GITHUB_OUTPUT
          printf "%s" "$TEST_RESULTS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          echo "all-passed=$ALL_PASSED" >> $GITHUB_OUTPUT

          # Display results
          printf "\nüìä Test Results Summary:\n%s" "$TEST_RESULTS"

          if [ "$ALL_PASSED" = false ]; then
            echo "‚ö†Ô∏è Some checks failed. Please review the PR and fix any issues."
          else
            echo "‚úÖ All checks passed successfully!"
          fi

      - name: Create Pull Request
        if: steps.update.outputs.updates-made == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore(deps): update dependencies (${{ github.event.inputs.update-type || 'patch' }})"
          title: "chore(deps): Automated dependency updates (${{ github.event.inputs.update-type || 'patch' }})"
          body: |
            ## ü§ñ Automated Dependency Update

            This PR was automatically created to update dependencies.

            ${{ needs.check-updates.outputs.update-summary }}

            ### ‚úÖ Checks Performed
            - [x] Dependencies updated
            - [x] Lock file regenerated

            ### üìä Test Results
            ${{ steps.tests.outputs.test-results || '‚è≥ Tests were not run (no updates made)' }}

            ### üìã Next Steps
            1. Review the changes in the Files tab
            2. Check the CI results (will run automatically after PR creation)
            3. If all checks pass, merge the PR
            4. If any checks fail, fix the issues and push to this branch

            > **Note**: The CI workflow will run additional checks after this PR is created.
            > Check the Actions tab for detailed results.

            ---
            *Generated by GitHub Actions Dependency Update workflow*
          branch: deps/automated-update-${{ github.run_number }}
          delete-branch: true
          labels: |
            dependencies
            automated
            ${{ github.event.inputs.update-type || 'patch' }}-update
          # Reviewers are automatically assigned via CODEOWNERS file

  vulnerability-check:
    name: Vulnerability Check After Update
    runs-on: ubuntu-latest
    needs: update-dependencies
    if: always()
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9
          run_install: false

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run security audit
        run: |
          echo "üîí Running security audit..."

          # Run audit and check for vulnerabilities
          pnpm audit --audit-level moderate || {
            echo "‚ö†Ô∏è Security vulnerabilities found after update"
            echo "Please review and fix before merging"
          }

      - name: Check licenses
        run: |
          echo "üìú Checking licenses..."

          # Simple license check (you can enhance this)
          pnpm licenses list || true
