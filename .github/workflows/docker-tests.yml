name: Docker Tests

on:
  push:
    branches: [main, develop]
    paths:
      - 'docker/**'
      - 'docker-compose.test.yml'
      - 'tests/**'
      - 'src/**'
      - 'package.json'
      - 'pnpm-lock.yaml'
      - '.github/workflows/docker-tests.yml'
  pull_request:
    branches: [main, develop]
    paths:
      - 'docker/**'
      - 'docker-compose.test.yml'
      - 'tests/**'
      - 'src/**'
      - 'package.json'
      - 'pnpm-lock.yaml'
      - '.github/workflows/docker-tests.yml'

env:
  NODE_VERSION: '20.x'
  DOCKER_BUILDKIT: 1
  COMPOSE_DOCKER_CLI_BUILD: 1

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  # Dockerç’°å¢ƒã§ã®Unit Tests
  docker-unit-tests:
    name: Docker Unit Tests
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Setup test environment
        run: |
          cp .env.test.example .env.test
          cp .env.test .env.local
          echo "DOCKER_HOST=unix:///var/run/docker.sock" >> .env.local

      - name: Build test image
        run: |
          docker compose -f docker-compose.test.yml build app-test

      - name: Run Unit Tests in Docker
        run: |
          # ãƒ†ã‚¹ãƒˆçµæœãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’äº‹å‰ä½œæˆ
          mkdir -p test-results coverage
          docker compose -f docker-compose.test.yml run --rm app-test pnpm test:unit

      - name: Clean up containers
        if: always()
        run: |
          docker compose -f docker-compose.test.yml down -v

  # Dockerç’°å¢ƒã§ã®Integration Tests
  docker-integration-tests:
    name: Docker Integration Tests
    runs-on: ubuntu-latest
    timeout-minutes: 25
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Setup test environment
        run: |
          cp .env.test.example .env.test
          cp .env.test .env.local
          echo "DOCKER_HOST=unix:///var/run/docker.sock" >> .env.local
          echo "TESTCONTAINERS_HOST_OVERRIDE=host.docker.internal" >> .env.local

      - name: Build integration test image
        run: |
          docker compose -f docker-compose.test.yml build app-integration

      - name: Run Integration Tests in Docker
        run: |
          # ãƒ†ã‚¹ãƒˆçµæœãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’äº‹å‰ä½œæˆ
          mkdir -p test-results
          docker compose -f docker-compose.test.yml run --rm app-integration

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: docker-integration-test-results
          path: test-results/
          retention-days: 7
          if-no-files-found: ignore

      - name: Clean up containers
        if: always()
        run: |
          docker compose -f docker-compose.test.yml down -v

  # Dockerç’°å¢ƒã§ã®E2E Tests
  docker-e2e-tests:
    name: Docker E2E Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30
    strategy:
      matrix:
        browser: [chromium, firefox]
      fail-fast: false
      # Matrix job ã®çµæœã‚’ Quality Gate ã§é©åˆ‡ã«è©•ä¾¡ã™ã‚‹ãŸã‚ã®è¨­å®š
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Setup test environment
        run: |
          cp .env.test.example .env.test
          cp .env.test .env.local
          echo "BASE_URL=http://app-server:3000" >> .env.local
          echo "PLAYWRIGHT_SKIP_WEBSERVER=true" >> .env.local

      - name: Build app server image
        run: |
          docker compose -f docker-compose.test.yml build app-server

      - name: Start app server
        run: |
          docker compose -f docker-compose.test.yml up app-server -d

      - name: Wait for app server to be ready
        run: |
          echo "Waiting for app server to start..."
          timeout 120s bash -c 'until docker compose -f docker-compose.test.yml exec -T app-server curl -f http://localhost:3000/api/health; do sleep 2; done'

      - name: Run Playwright E2E Tests in Docker
        run: |
          # ãƒ†ã‚¹ãƒˆçµæœãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’äº‹å‰ä½œæˆ
          mkdir -p test-results playwright-report
          docker compose -f docker-compose.test.yml run --rm \
            -e PLAYWRIGHT_PROJECT=${{ matrix.browser }} \
            playwright npx playwright test --project=${{ matrix.browser }} --config=playwright.docker.config.ts

      - name: Upload Playwright report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: docker-playwright-report-${{ matrix.browser }}
          path: playwright-report/
          retention-days: 7
          if-no-files-found: ignore

      - name: Upload test videos
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: docker-playwright-videos-${{ matrix.browser }}
          path: test-results/
          retention-days: 7
          if-no-files-found: ignore

      - name: Show container logs on failure
        if: failure()
        run: |
          echo "=== App Server Logs ==="
          docker compose -f docker-compose.test.yml logs app-server

      - name: Clean up containers
        if: always()
        run: |
          docker compose -f docker-compose.test.yml down -v

  # å…¨ãƒ†ã‚¹ãƒˆã‚¹ã‚¤ãƒ¼ãƒˆå®Ÿè¡Œï¼ˆçµ±åˆç¢ºèªï¼‰
  docker-all-tests:
    name: Docker All Tests Integration
    runs-on: ubuntu-latest
    timeout-minutes: 35
    needs: [docker-unit-tests, docker-integration-tests]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Setup test environment
        run: |
          cp .env.test.example .env.test
          cp .env.test .env.local
          echo "DOCKER_HOST=unix:///var/run/docker.sock" >> .env.local
          echo "TESTCONTAINERS_HOST_OVERRIDE=host.docker.internal" >> .env.local

      - name: Build all test images
        run: |
          docker compose -f docker-compose.test.yml build

      - name: Run complete test suite in Docker
        run: |
          # App serverã‚’èµ·å‹•
          docker compose -f docker-compose.test.yml up app-server -d

          # App serverã®æº–å‚™å®Œäº†ã‚’å¾…æ©Ÿ
          timeout 120s bash -c 'until docker compose -f docker-compose.test.yml exec -T app-server curl -f http://localhost:3000/api/health; do sleep 2; done'

          # å…¨ãƒ†ã‚¹ãƒˆã‚¹ã‚¤ãƒ¼ãƒˆå®Ÿè¡Œ
          docker compose -f docker-compose.test.yml run --rm all-tests

      - name: Generate comprehensive test report
        if: always()
        run: |
          echo "# Docker Test Suite Summary" > docker-test-summary.md
          echo "" >> docker-test-summary.md
          echo "## Test Execution Results" >> docker-test-summary.md
          echo "" >> docker-test-summary.md

          # ã‚³ãƒ³ãƒ†ãƒŠçŠ¶æ…‹ç¢ºèª
          echo "### Container Status" >> docker-test-summary.md
          echo '```' >> docker-test-summary.md
          docker compose -f docker-compose.test.yml ps >> docker-test-summary.md
          echo '```' >> docker-test-summary.md
          echo "" >> docker-test-summary.md

          # ãƒ­ã‚°å‡ºåŠ›
          echo "### Service Logs" >> docker-test-summary.md
          echo '```' >> docker-test-summary.md
          docker compose -f docker-compose.test.yml logs --tail=50 >> docker-test-summary.md
          echo '```' >> docker-test-summary.md

      - name: Upload comprehensive test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: docker-all-tests-results
          path: |
            test-results/
            coverage/
            playwright-report/
            docker-test-summary.md
          retention-days: 7

      - name: Clean up all containers
        if: always()
        run: |
          docker compose -f docker-compose.test.yml down -v
          docker system prune -f

  # Dockerç’°å¢ƒã®å“è³ªã‚²ãƒ¼ãƒˆ
  docker-quality-gate:
    name: Docker Quality Gate
    runs-on: ubuntu-latest
    needs: [docker-unit-tests, docker-integration-tests, docker-e2e-tests]
    if: always()
    steps:
      - name: Check Docker test results
        run: |
          echo "=== Docker Quality Gate Analysis ==="
          echo "Checking Docker test results..."

          # ãƒ‡ãƒãƒƒã‚°æƒ…å ±: å„ã‚¸ãƒ§ãƒ–ã®çµæœå€¤ã‚’å‡ºåŠ›
          echo "ğŸ“Š Job Results Debug Information:"
          echo "  docker-unit-tests.result: '${{ needs.docker-unit-tests.result }}'"
          echo "  docker-integration-tests.result: '${{ needs.docker-integration-tests.result }}'"
          echo "  docker-e2e-tests.result: '${{ needs.docker-e2e-tests.result }}'"
          echo ""

          # å¤±æ•—ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼
          FAILED_JOBS=0
          FAILED_NAMES=""

          # Docker Unit Tests ãƒã‚§ãƒƒã‚¯
          if [ "${{ needs.docker-unit-tests.result }}" != "success" ]; then
            echo "âŒ Docker Unit Tests: '${{ needs.docker-unit-tests.result }}'"
            FAILED_JOBS=$((FAILED_JOBS + 1))
            FAILED_NAMES="${FAILED_NAMES}Unit Tests, "
          else
            echo "âœ… Docker Unit Tests: success"
          fi

          # Docker Integration Tests ãƒã‚§ãƒƒã‚¯
          if [ "${{ needs.docker-integration-tests.result }}" != "success" ]; then
            echo "âŒ Docker Integration Tests: '${{ needs.docker-integration-tests.result }}'"
            FAILED_JOBS=$((FAILED_JOBS + 1))
            FAILED_NAMES="${FAILED_NAMES}Integration Tests, "
          else
            echo "âœ… Docker Integration Tests: success"
          fi

          # Docker E2E Tests ãƒã‚§ãƒƒã‚¯ (matrix job - è¤‡æ•°çµæœã®å¯èƒ½æ€§ã‚’è€ƒæ…®)
          if [ "${{ needs.docker-e2e-tests.result }}" != "success" ]; then
            echo "âŒ Docker E2E Tests: '${{ needs.docker-e2e-tests.result }}'"
            FAILED_JOBS=$((FAILED_JOBS + 1))
            FAILED_NAMES="${FAILED_NAMES}E2E Tests, "
          else
            echo "âœ… Docker E2E Tests: success"
          fi

          echo ""
          echo "=== Quality Gate Summary ==="

          if [ $FAILED_JOBS -eq 0 ]; then
            echo "âœ… All Docker tests passed successfully"
            echo "ğŸ³ Docker-based CI/CD pipeline is working correctly"
            echo "ğŸ“ˆ Quality Gate: PASSED (0 failures)"
          else
            echo "âŒ Quality Gate: FAILED ($FAILED_JOBS failures)"
            echo "ğŸ” Failed components: ${FAILED_NAMES%, }"
            echo ""
            echo "ğŸ’¡ Debugging tips:"
            echo "  1. Check individual job logs for detailed error information"
            echo "  2. Verify Docker compose configuration and test environments"
            echo "  3. Ensure all dependencies and services are properly configured"
            echo "  4. Check for resource constraints or timeout issues"
            exit 1
          fi

      - name: Post success notification
        if: success()
        run: |
          echo "Phase 3: Docker Test Environment Integration - âœ… COMPLETED"
          echo "- Unit Tests in Docker: âœ…"
          echo "- Integration Tests in Docker: âœ…"
          echo "- E2E Tests in Docker: âœ…"
          echo "- Testcontainers integration: âœ…"
          echo "- CI/CD Docker integration: âœ…"
