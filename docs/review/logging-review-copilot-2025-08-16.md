# ログ機能 セキュリティ/品質レビュー（2025-08-16）

対象:

- コード: `src/lib/logger/**`
- ドキュメント: `docs/developer_guide/logging/logging-system-overview.ja.md`, `logging-configuration-guide.ja.md`, `logging-troubleshooting-guide.ja.md`

以下、番号付きで指摘事項を記載します（各項目に「指摘内容」「指摘の意図」「重要度」を明記）。

1. 指摘内容: Loki 送信時に `Content-Encoding: gzip` を付与しているが実際の圧縮をしていない（`loki-client.ts`）
   - 指摘の意図: 不正なヘッダーは Loki 側の解釈エラーやログ欠落を招くため、ヘッダーと実体は一致させるべき。未実装ならヘッダーを付けないか、実際に gzip 圧縮を行う。
   - 重要度: 高

2. 指摘内容: Loki Basic認証で `btoa` を使用（Node.jsでは未定義）。`Buffer.from(...).toString('base64')` を使用すべき（`loki-client.ts`）
   - 指摘の意図: サーバー環境で実行時エラーとなり送信が失敗するのを防ぐ。
   - 重要度: 高

3. 指摘内容: Loki ラベルに高カーディナリティの値（`request_id`, `trace_id`, `span_id`, `http_url`, `user_id`, `session_id` など）を付与（`loki-transport.ts`）
   - 指摘の意図: Loki のインデックス肥大・コスト増・クエリ遅延を防ぐ。ラベルは低カーディナリティ（環境/サービス/レベル/固定的な分類）に限定し、`request_id` 等はメタデータに移す。
   - 重要度: 致命的

4. 指摘内容: Redaction ルールが過剰/不足。`key` は汎用すぎて過剰マスクの恐れ。逆に `jwt`, `apiKey`, `clientSecret`, `creditCard` などドキュメント記載の一部が未カバー（`utils.ts` の `REDACT_PATHS` とドキュメントの不一致）
   - 指摘の意図: 過剰マスクで可観測性を損なわず、機密は確実にマスクする。コードとドキュメントの整合性を取り、具体的なパス（`*.apiKey` 等）を追加し、汎用的すぎるキーは再検討する。
   - 重要度: 高

5. 指摘内容: IPハッシュの出力が 8 文字プレフィックスのみ（`ip_XXXXXXXX`）。ドキュメントの例（`sha256:...`）とも不一致（`crypto.ts` / 各ドキュメント）
   - 指摘の意図: 8 文字は衝突リスクが高い。追跡・相関用途の一意性を確保しつつ匿名性を保つため、少なくとも 16–32 文字程度へ拡張し、フォーマットをドキュメントと揃える。
   - 重要度: 高

6. 指摘内容: IPハッシュの自動適用に関する記述と実装の差異。自動ハッシュはミドルウェア経由の `createRequestContext` でのみ行われ、任意ログの `clientIp` 等は自動ハッシュされない（ドキュメントは自動を示唆）
   - 指摘の意図: 「自動ハッシュ」の適用範囲を明確化するか、フィールドベースの自動ハッシュ（例: `clientIp` → ハッシュ）を実装して誤解を防ぐ。
   - 重要度: 中

7. 指摘内容: レート制限/動的サンプリングがロガー経路に未統合。`rate-limiter.ts` はあるが、`server.ts`/`client.ts` で判定・適用していない（ドキュメントは自動適用を示唆）
   - 指摘の意図: ログフラッド耐性と性能保証のため、出力前にサンプリング/レート制限を統合する。少なくともエラー急増時のアダプティブサンプリングを適用。
   - 重要度: 高

8. 指摘内容: `LOG_FORMAT`, `LOG_SAMPLING_RATE`, `LOG_MAX_OBJECT_SIZE` などドキュメント記載の環境変数がコードで未使用（複数ドキュメント）
   - 指摘の意図: 利用者の混乱防止。未サポートの設定はドキュメントから削除/注記し、必要なら実装を追加する。
   - 重要度: 中

9. 指摘内容: `initializeLogger` の Loki 有効化デフォルトが `true`（`LOKI_ENABLED !== 'false'`）。開発環境で意図せず外部送信され得る（`index.ts`）
   - 指摘の意図: デフォルトは「無効」。明示的に有効化したときのみ外部送信することでプライバシー/誤送信リスクを抑制。
   - 重要度: 中

10. 指摘内容: `process.on('uncaughtException')` で常に `process.exit(1)`。Next.js 実行環境では開発体験/可用性に影響（`index.ts`）
    - 指摘の意図: 本番のみ即時終了、開発/テストではスタック確認やホットリロード継続を優先するなど挙動を分岐。
    - 重要度: 中

11. 指摘内容: Pino `hooks.logMethod` の引数変換が複雑で一部ケースで `undefined` オブジェクトが先頭に渡る可能性（`server.ts`）
    - 指摘の意図: ログ整形はラッパーレイヤーで完結させ、`hooks` は最小化。引数組み替え時は `undefined` を渡さない等のガードを徹底。
    - 重要度: 低

12. 指摘内容: ドキュメントの性能計測 API 例が実装と不一致（`measurePerformance/Async` の戻り値に `duration` がある前提になっている）
    - 指摘の意図: 利用者が誤った前提で実装しないよう、戻り値や使用例を現実装に合わせて修正（必要なら API を拡張）。
    - 重要度: 中

13. 指摘内容: Loki `LOKI_TIMEOUT` デフォルト値の表記が不一致（ドキュメントは 10000ms、`createDefaultLokiConfig` は 5000ms）
    - 指摘の意図: 設定の正確性担保。ドキュメントとコードのデフォルト値を統一。
    - 重要度: 低

14. 指摘内容: Redaction のドキュメント例に `creditCard`, `bankAccount`, `apiKey` 等があるが、コード側の正規化されたキー（`credit_card` 等）と食い違い（表記ゆれ）
    - 指摘の意図: 実運用でマスク漏れが発生しないよう、キャメル/スネーク両方や一般的バリエーションを網羅。
    - 重要度: 中

15. 指摘内容: Loki 送信変換（`transformLog`）で `args` に `Error` が含まれるとシリアライズ粒度が不足（`sanitizeLogEntry` は制御文字対策中心）
    - 指摘の意図: `Error` は `serializeError` で構造化し、`metadata.error` 等に格納して検索性を高める。
    - 重要度: 低

16. 指摘内容: ミドルウェア/クライアントログで URL 全体をメタデータではなくラベルに入れる設計誤りの波及（ドキュメントも URL ラベル示唆）
    - 指摘の意図: URL はパスやルート名へ正規化し、ラベル化は避ける。クエリ/ユーザー/ID等はメタデータ側に限定し、カーディナリティを制御。
    - 重要度: 高

17. 指摘内容: セキュリティガイドの最小秘密鍵長（64文字）と実装バリデーション（32文字以上）が不一致（`crypto.ts` / ドキュメント）
    - 指摘の意図: しきい値を統一（推奨: 64文字以上）。警告/バリデーションも同値に。
    - 重要度: 中

18. 指摘内容: Pino pretty 使用条件がドキュメントの `LOG_FORMAT` と連動していない（`server.ts` とドキュメントの不一致）
    - 指摘の意図: 設定一元化。`LOG_FORMAT=pretty` を尊重するか、ドキュメントから該当記述を削除/修正。
    - 重要度: 低

---

補足/推奨対応（抜粋）:

- Loki: 圧縮実装（実際に gzip）またはヘッダー削除、Basic認証の `Buffer` 化、ラベル設計の見直し（高カーディナリティ排除）
- Redaction: ルールの再設計（不足キー追加、過剰キー削減、表記ゆれ対応）、テスト追加
- IPハッシュ: 出力長/フォーマット統一（例: `sha256:<32〜64hex>`）、ドキュメント整合
- レート制限/サンプリング: `serverLoggerWrapper`/`clientLogger` 経路に統合（少なくともエラー急増時）
- ドキュメント: 未実装設定の明示、使用例の修正（性能計測戻り値など）、デフォルト値の統一

以上。
